// MCP Workflow Tracker - Prisma Schema (SQLite)
// Usage: Standalone MCP server without external DB dependency

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELS (SQLite compatible)
// Note: Enums stored as TEXT, arrays as JSON strings
// ============================================

model Workflow {
  id          String   @id @default(cuid())
  name        String
  description String?
  plan        String?  // JSON string
  status      String   @default("IN_PROGRESS") // WorkflowStatus enum
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Aggregated metrics (computed on task completion)
  totalDurationMs Int? // Sum of all task durations
  totalTokens     Int? // Sum of all tokens (input + output)

  tasks Task[]

  @@index([status])
  @@index([createdAt])
}

model Task {
  id           String   @id @default(cuid())
  workflowId   String
  parentTaskId String?
  name         String
  goal         String
  status       String   @default("IN_PROGRESS") // TaskStatus enum

  // Scope (JSON array)
  areas String @default("[]")

  // Snapshot data (Git ou Checksum)
  snapshotId   String?
  snapshotType String?
  snapshotData String? // JSON string

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Outcome
  summary            String?
  achievements       String  @default("[]") // JSON array
  limitations        String  @default("[]") // JSON array
  manualReviewNeeded Boolean @default(false)
  manualReviewReason String?
  nextSteps          String  @default("[]") // JSON array

  // Metadata
  packagesAdded    String  @default("[]") // JSON array
  packagesRemoved  String  @default("[]") // JSON array
  commandsExecuted String  @default("[]") // JSON array
  testsStatus      String? // TestsStatus enum

  // Token metrics
  tokensInput  Int? // Input tokens used
  tokensOutput Int? // Output tokens generated

  // Files changed
  filesAdded    String @default("[]") // JSON array
  filesModified String @default("[]") // JSON array
  filesDeleted  String @default("[]") // JSON array

  // Verification
  scopeMatch      Boolean?
  unexpectedFiles String  @default("[]") // JSON array
  warnings        String  @default("[]") // JSON array

  // Relations
  workflow   Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  parentTask Task?       @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subtasks   Task[]      @relation("TaskHierarchy")
  decisions  Decision[]
  issues     Issue[]
  milestones Milestone[]

  @@index([workflowId])
  @@index([parentTaskId])
  @@index([status])
  @@index([startedAt])
}

model Decision {
  id                String   @id @default(cuid())
  taskId            String
  category          String   // DecisionCategory enum
  question          String
  optionsConsidered String   @default("[]") // JSON array
  chosen            String
  reasoning         String
  tradeOffs         String?
  createdAt         DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([createdAt])
}

model Issue {
  id                  String   @id @default(cuid())
  taskId              String
  type                String   // IssueType enum
  description         String
  resolution          String
  requiresHumanReview Boolean  @default(false)
  createdAt           DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([createdAt])
}

model Milestone {
  id        String   @id @default(cuid())
  taskId    String
  message   String
  progress  Int?
  metadata  String?  // JSON string
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([createdAt])
}
